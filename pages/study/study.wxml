<!--pages/study/study.wxml-->
<view class="container" bindtouchstart="touchStart" bindtouchend="touchEnd">
  <!-- 去掉外层 .card，直接平铺 -->
  <view class="content-wrapper {{slideDirection}}" style="transform: translateX({{slideOffset}}%) rotateY({{rotateY}}deg);">
    <!-- 顶部功能区：模式标签 + Level + 进度 + 收藏 -->
    <view class="card-header">
      <view class="mode-label" wx:if="{{studyMode !== 'normal'}}">{{modeLabel}}</view>
      <view class="mode-label" wx:else>正确率: {{accuracy}}%</view>
      
      <view class="header-right">
        <view class="level-tag level-{{currentWord.level}}" wx:if="{{currentWord.level}}">{{currentWord.level}}</view>
        <view class="progress-pill">
          <text class="progress-text">{{currentIndex + 1}}/{{totalWords}}</text>
        </view>
        <view class="fav-btn" catchtap="toggleFavorite">
          <text class="fav-icon" style="color: {{isFavorited ? '#f6ad55' : '#cbd5e0'}};">★</text>
        </view>
      </view>
    </view>

    <!-- 单词核心区 -->
    <view class="word-section">
      <text class="word">{{currentWord.word}}</text>
      <text class="pronunciation">{{currentWord.pronunciation}}</text>
      
      <!-- 胶囊式词性标签 -->
      <view class="pos-capsule" wx:if="{{currentWord.posObj.abbr}}">
        <text class="pos-abbr">{{currentWord.posObj.abbr}}</text>
        <text class="pos-cn" wx:if="{{currentWord.posObj.cn}}">{{currentWord.posObj.cn}}</text>
      </view>
    </view>

    <!-- 中间部分：例句卡片 (保留独立视觉，但悬浮在页面上) -->
    <view class="context-card" wx:if="{{currentWord.formattedExample}}">
      <view class="example-content">
        <rich-text class="example-text" nodes="{{currentWord.formattedExample}}"></rich-text>
        <text class="example-translation {{hasAnswered ? 'fade-in' : ''}}" wx:if="{{hasAnswered && currentWord.example_meaning}}">{{currentWord.example_meaning}}</text>
      </view>
    </view>

    <!-- 占位符：确保选项区沉底 -->
    <view class="spacer"></view>

    <!-- 下半部分：选项区 -->
    <view class="options-section" wx:if="{{!hasAnswered}}">
      <block wx:for="{{currentWord.options}}" wx:key="text">
        <button 
          class="option-btn"
          bindtap="selectOption" 
          data-index="{{index}}"
          hover-class="btn-hover"
        >
          {{item.text}}
        </button>
      </block>
    </view>
    
    <!-- 底部控制区 -->
    <view class="footer-area">
      <!-- 回答后显示控制按钮 -->
      <view wx:if="{{hasAnswered}}" class="footer-buttons">
        <!-- 详情按钮 (左侧) -->
        <button class="detail-btn" bindtap="toggleDetail">查看详情</button>
        
        <!-- 错误且不在错题本时显示加入 -->
        <button class="add-mistake-btn" wx:if="{{!isCorrect && showAddMistakeBtn}}" bindtap="addToMistakeBook">加入错题本</button>
        
        <!-- 错题模式且做对显示删除 -->
        <button class="remove-mistake-btn" wx:if="{{studyMode === 'mistake' && isCorrect && showRemoveFromMistake}}" bindtap="removeFromMistakeBook">移除</button>
        
        <!-- 下一题 (右侧) -->
        <button class="next-btn" bindtap="nextWord">下一题 ➜</button>
      </view>
    </view>

    <!-- 详情弹窗 -->
    <view class="modal-mask" wx:if="{{showDetailModal}}" bindtap="toggleDetail">
      <view class="modal-content" catchtap="true">
        <view class="modal-header">单词详情</view>
        <scroll-view scroll-y class="modal-body">
            <view class="detail-item">
                <view class="item-label">单词</view>
                <view class="item-value highlight">{{currentWord.word}}</view>
            </view>
            <view class="detail-item">
                <view class="item-label">词性</view>
                <view class="item-value">{{currentWord.posObj.abbr}} {{currentWord.posObj.cn}}</view>
            </view>
            <view class="detail-item">
                <view class="item-label">释义</view>
                <view class="item-value">{{currentWord.meaning}}</view>
            </view>
            
            <!-- 新增：详细解释和变形 -->
            <view class="detail-item" wx:if="{{currentWord.detail}}">
                <view class="item-label">详解</view>
                <view class="item-value">{{currentWord.detail}}</view>
            </view>

            <view class="detail-item">
                <view class="item-label">例句</view>
                <view class="item-value">
                    <rich-text nodes="{{currentWord.formattedExample}}"></rich-text>
                    <view class="trans">{{currentWord.example_meaning}}</view>
                </view>
            </view>
        </scroll-view>
        <button class="close-btn" bindtap="toggleDetail">关闭</button>
      </view>
    </view>

  <!-- 彩带雨动画层 -->
  <view class="confetti-container" wx:if="{{showConfetti}}">
    <view class="confetti" wx:for="{{confettiList}}" wx:key="index" wx:for-item="item" wx:for-index="index" style="left: {{item.left}}; top: {{item.top}}; background-color: {{item.color}}; width: {{item.size}}; height: {{item.size}}; animation-delay: {{item.delay}}; animation-duration: {{item.duration}}; transform: rotate({{item.rotation}});"></view>
  </view>

  <!-- 庆祝文字特效 -->
  <view class="celebration-text {{showCelebrationText ? 'show' : ''}}" wx:if="{{showCelebrationText}}">
    <text class="celebration-text-content">{{celebrationText}}</text>
  </view>
</view>
