<!--pages/study/study.wxml-->
<view class="container" bindtouchstart="touchStart" bindtouchend="touchEnd">
  <!-- 固定容器：锁定所有内容位置，防止布局变化 -->
  <view class="fixed-container">
    <!-- 去掉外层 .card，直接平铺 -->
    <view class="content-wrapper {{slideDirection}}" style="transform: translateX({{slideOffset}}%) rotateY({{rotateY}}deg);">
    <!-- 顶部功能区：左上角 Level + 进度，下方正确率，右上角收藏 -->
    <view class="card-header">
      <view class="header-left">
        <view class="header-top-row">
        <view class="level-tag level-{{currentWord.level}}" wx:if="{{currentWord.level}}">{{currentWord.level}}</view>
        <view class="progress-pill">
          <text class="progress-text">{{currentIndex + 1}}/{{totalWords}}</text>
        </view>
        </view>
        <view class="mode-label" wx:if="{{studyMode === 'normal'}}">当前正确率: {{accuracy}}%</view>
        <view class="mode-label" wx:else>{{modeLabel}}</view>
      </view>
      
      <view class="header-right">
        <view class="fav-btn" catchtap="toggleFavorite">
          <text class="fav-icon" style="color: {{isFavorited ? '#f6ad55' : '#cbd5e0'}};">★</text>
        </view>
      </view>
    </view>

    <!-- 单词核心区 -->
    <view class="word-section">
      <view class="word-row">
      <text class="word">{{currentWord.word}}</text>
        <!-- 详情图标 (始终显示) -->
        <view class="detail-icon-btn" bindtap="toggleDetail">
          <text>ℹ️</text>
        </view>
      </view>
      <text class="pronunciation">{{currentWord.pronunciation}}</text>
      
      <!-- 胶囊式词性标签 -->
      <view class="pos-capsule" wx:if="{{currentWord.posObj.abbr}}">
        <text class="pos-abbr">{{currentWord.posObj.abbr}}</text>
        <text class="pos-cn" wx:if="{{currentWord.posObj.cn}}">{{currentWord.posObj.cn}}</text>
      </view>
    </view>

    <!-- 中间部分：例句卡片 (保留独立视觉，但悬浮在页面上) -->
    <view class="context-card" wx:if="{{currentWord.formattedExample}}">
      <view class="example-content">
        <rich-text class="example-text" nodes="{{currentWord.formattedExample}}"></rich-text>
        <!-- 例句翻译始终占据空间，避免布局变化 -->
        <text class="example-translation {{hasAnswered ? 'fade-in' : 'hidden'}}" wx:if="{{currentWord.example_meaning}}">{{currentWord.example_meaning}}</text>
      </view>
    </view>

    <!-- 占位符：确保选项区沉底 -->
    <view class="spacer"></view>

    <!-- 下半部分：选项区 (始终显示) -->
    <view class="options-section">
      <block wx:for="{{currentWord.options}}" wx:key="text">
        <button 
          class="option-btn {{hasAnswered && item.selected ? (item.isCorrect ? 'correct' : 'wrong') : ''}} {{hasAnswered && item.isCorrect && !item.selected ? 'correct-hint' : ''}}"
          bindtap="selectOption" 
          data-index="{{index}}"
          hover-class="btn-hover"
          disabled="{{hasAnswered}}"
        >
          {{item.text}}
        </button>
      </block>
    </view>
    
    <!-- 底部控制区 (固定布局) -->
    <view class="footer-area">
      <!-- 只有答对且满足所有条件时才居中，答错时绝不居中 -->
      <!-- 关键：isCorrect 必须为 true，且 showAddMistakeBtn 必须为 false -->
      <view class="footer-buttons {{hasAnswered && isCorrect && shouldCenterButton && showAddMistakeBtn == false && (studyMode != 'mistake' || showRemoveFromMistake == false) ? 'center' : ''}}">
        <!-- 左侧：错题本按钮 (始终存在，答错时显示) -->
        <button 
          class="add-mistake-btn {{hasAnswered && !isCorrect && showAddMistakeBtn ? '' : 'hidden'}}" 
          bindtap="addToMistakeBook"
          disabled="{{!(hasAnswered && !isCorrect && showAddMistakeBtn)}}"
        >加入错题本</button>
        <button 
          class="remove-mistake-btn {{hasAnswered && studyMode === 'mistake' && isCorrect && showRemoveFromMistake ? '' : 'hidden'}}" 
          bindtap="removeFromMistakeBook"
          disabled="{{!(hasAnswered && studyMode === 'mistake' && isCorrect && showRemoveFromMistake)}}"
        >移除</button>
        
        <!-- 右侧：下一题按钮 (始终存在，答题后显示) -->
        <button 
          class="next-btn {{hasAnswered ? '' : 'hidden'}}" 
          bindtap="nextWord"
          disabled="{{!hasAnswered}}"
        >下一题 ➜</button>
      </view>
    </view>
    </view>
  </view>

  <!-- 详情弹窗 -->
  <view class="modal-mask" wx:if="{{showDetailModal}}" bindtap="toggleDetail">
      <view class="modal-content" catchtap="true">
        <view class="modal-header">单词详情</view>
        <scroll-view scroll-y class="modal-body">
            <view class="detail-item">
                <view class="item-label">单词</view>
                <view class="item-value highlight">{{currentWord.word}}</view>
            </view>
            <view class="detail-item">
                <view class="item-label">词性</view>
                <view class="item-value">{{currentWord.posObj.abbr}} {{currentWord.posObj.cn}}</view>
            </view>
            <view class="detail-item">
                <view class="item-label">释义</view>
                <view class="item-value">{{currentWord.meaning}}</view>
    </view>
    
            <!-- 新增：详细解释和变形 -->
            <view class="detail-item" wx:if="{{currentWord.detail}}">
                <view class="item-label">详解</view>
                <view class="item-value">{{currentWord.detail}}</view>
            </view>

            <view class="detail-item">
                <view class="item-label">例句</view>
                <view class="item-value">
                    <rich-text nodes="{{currentWord.formattedExample}}"></rich-text>
                    <view class="trans">{{currentWord.example_meaning}}</view>
                </view>
            </view>
        </scroll-view>
        <button class="close-btn" bindtap="toggleDetail">关闭</button>
      </view>
  </view>

  <!-- 彩带雨动画层 -->
  <view class="confetti-container" wx:if="{{showConfetti}}">
    <view class="confetti" wx:for="{{confettiList}}" wx:key="index" wx:for-item="item" wx:for-index="index" style="left: {{item.left}}; top: {{item.top}}; background-color: {{item.color}}; width: {{item.size}}; height: {{item.size}}; animation-delay: {{item.delay}}; animation-duration: {{item.duration}}; transform: rotate({{item.rotation}});"></view>
  </view>

  <!-- 庆祝文字特效 -->
  <view class="celebration-text {{showCelebrationText ? 'show' : ''}}" wx:if="{{showCelebrationText}}">
    <text class="celebration-text-content">{{celebrationText}}</text>
  </view>
</view>
